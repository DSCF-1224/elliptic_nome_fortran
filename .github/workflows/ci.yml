name: CI

on: [push, pull_request]

defaults:
  run:
    shell: bash

jobs:

  fypp:

    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v5

      - name: Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '>=3.5'

      - name: Verify python installation
        run: python3 -V

      - name: Install fypp
        run: pip install --upgrade fypp ninja

      - name: Verify fypp installation
        run: fypp --version

      - name: Run fypp
        run: |
          cd src
          chmod +x ./run_fypp.sh
          ./run_fypp.sh
          cd ../test
          chmod +x ./run_fypp.sh
          ./run_fypp.sh
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: src-f90
          path: src/*.f90
          retention-days: 1

  test:

    needs: fypp

    runs-on: ubuntu-latest

    strategy:
      matrix:
        profile: [debug, release]

    steps:

      - uses: actions/checkout@v5

      - name: Get .f90 files generated by fypp
        uses: actions/download-artifact@v4
        with:
          name: src-f90
          path: src-f90

      - name: Copy .f90 files generated by fypp
        run: cp ./src-f90/*.f90 ./src

      - name: Check the .f90 files generated by fypp
        run: |
          cd src
          ls -a
          cd ..

      - name: Install fpm
        uses: fortran-lang/setup-fpm@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify fpm installation
        run: fpm --version

      - name: Build library using fpm
        run: fpm build --profile ${{ matrix.profile }}
